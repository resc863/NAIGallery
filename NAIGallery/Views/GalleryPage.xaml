<Page
    x:Class="NAIGallery.Views.GalleryPage"
    x:Name="PageRoot"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:models="using:NAIGallery.Models"
    xmlns:vm="using:NAIGallery.ViewModels"
    xmlns:muxc="using:Microsoft.UI.Xaml.Controls"
    xmlns:controls="using:NAIGallery.Controls"
    xmlns:toolkit="using:CommunityToolkit.WinUI.Controls">
    <Grid RowDefinitions="Auto,*" ColumnDefinitions="*" KeyDown="Root_KeyDown" KeyUp="Root_KeyUp" PointerWheelChanged="Root_PointerWheelChanged">
        <!-- Top bar with centered search -->
        <RelativePanel x:Name="TopBar" Grid.Row="0" Margin="8" VerticalAlignment="Top">
            <StackPanel x:Name="LeftBar" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center" RelativePanel.AlignLeftWithPanel="True">
                <Button Content="폴더 열기" Click="OpenFolder_Click" />
                <ComboBox x:Name="SortFieldCombo" Width="120" SelectedIndex="0" SelectionChanged="SortFieldCombo_SelectionChanged">
                    <ComboBoxItem Content="이름" Tag="Name" IsSelected="True" />
                    <ComboBoxItem Content="날짜" Tag="Date" />
                </ComboBox>
                <ToggleButton Width="40" Click="SortDirectionToggle_Click">
                    <TextBlock x:Name="SortDirText" Text="↑" HorizontalAlignment="Center" VerticalAlignment="Center" />
                </ToggleButton>
                <Button Width="40" Click="RefreshUI_Click" ToolTipService.ToolTip="UI 새로고침 (F5)">
                    <FontIcon Glyph="&#xE72C;" FontSize="16" />
                </Button>
                <!-- x:Bind instead of Binding for AOT friendliness -->
                <ProgressRing IsActive="{x:Bind ViewModel.IsIndexing, Mode=OneWay}" Width="28" Height="28" />
            </StackPanel>
            <AutoSuggestBox x:Name="SearchBox"
                            Width="500"
                            PlaceholderText="태그 검색"
                            Text="{x:Bind ViewModel.SearchQuery, Mode=TwoWay}"
                            RelativePanel.AlignHorizontalCenterWithPanel="True"
                            VerticalAlignment="Center"
                            ItemsSource="{x:Bind ViewModel.TagSuggestions, Mode=OneWay}"
                            QueryIcon="Find"
                            TextChanged="SearchBox_TextChanged"
                            SuggestionChosen="SearchBox_SuggestionChosen" />
        </RelativePanel>

        <!-- ScrollViewer hosting ItemsRepeater using toolkit StaggeredLayout (masonry) -->
        <ScrollViewer x:Name="RepeaterScroll" Grid.Row="1" HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto">
            <muxc:ItemsRepeater x:Name="GalleryView" ItemsSource="{x:Bind ViewModel.Images, Mode=OneWay}">
                <muxc:ItemsRepeater.Layout>
                    <toolkit:StaggeredLayout DesiredColumnWidth="{x:Bind MinItemWidth, Mode=OneWay}" />
                </muxc:ItemsRepeater.Layout>
                <muxc:ItemsRepeater.ItemTemplate>
                    <DataTemplate x:DataType="models:ImageMetadata">
                        <controls:AspectPresenter
                            Width="{Binding ElementName=PageRoot, Path=TileLineHeight}"
                            AspectRatio="{x:Bind AspectRatio, Mode=OneWay}">
                            <Border x:Name="TileBorder"
                                    Tag="{x:Bind FilePath}"
                                    Margin="4"
                                    BorderBrush="Gray"
                                    BorderThickness="1"
                                    CornerRadius="4"
                                    Background="#20808080"
                                    Tapped="Item_Tapped"
                                    PointerEntered="Tile_PointerEntered"
                                    PointerExited="Tile_PointerExited">
                                <Grid Background="Transparent">
                                    <!-- Placeholder for loading state - 실제 로딩 중인 항목만 표시 -->
                                    <Grid x:Name="PlaceholderGrid"
                                          Background="#10808080"
                                          Visibility="{x:Bind IsLoadingThumbnail, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="8">
                                            <ProgressRing IsActive="True" Width="24" Height="24" />
                                            <TextBlock Text="로딩 중..."
                                                       Foreground="Gray"
                                                       FontSize="12"
                                                       HorizontalAlignment="Center" />
                                        </StackPanel>
                                    </Grid>
                                    
                                    <Image x:Name="connectedElement"
                                           Tag="{x:Bind FilePath}"
                                           Source="{x:Bind Thumbnail, Mode=OneWay}"
                                           Stretch="UniformToFill"
                                           HorizontalAlignment="Stretch"
                                           VerticalAlignment="Stretch"
                                           ImageOpened="Tile_ImageOpened"
                                           RenderTransformOrigin="0.5,0.5">
                                        <Image.RenderTransform>
                                            <ScaleTransform ScaleX="1" ScaleY="1" />
                                        </Image.RenderTransform>
                                    </Image>
                                </Grid>
                            </Border>
                        </controls:AspectPresenter>
                    </DataTemplate>
                </muxc:ItemsRepeater.ItemTemplate>
            </muxc:ItemsRepeater>
        </ScrollViewer>
    </Grid>
</Page>